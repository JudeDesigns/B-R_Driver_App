generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String                   @id @default(uuid())
  username                String                   @unique
  password                String
  role                    Role                     @default(DRIVER)
  fullName                String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  isDeleted               Boolean                  @default(false)
  attendanceAppUserId     String?
  cachedClockInStatus     Boolean                  @default(false)
  cachedClockInStatusAt   DateTime?
  lastClockInStatusCheck  DateTime?
  lastKnownLatitude       Float?
  lastKnownLongitude      Float?
  lastLocationUpdate      DateTime?
  locationAccuracy        Float?
  adminNotes              AdminNote[]              @relation("AdminNotes")
  dailyKPIs               DailyKPI[]               @relation("DriverKPIs")
  documentAcknowledgments DocumentAcknowledgment[] @relation("DriverDocumentAcknowledgments")
  documents               Document[]               @relation("DocumentUploads")
  driverLocations         DriverLocation[]         @relation("DriverLocationUpdates")
  files                   File[]                   @relation("FileUploads")
  routes                  Route[]                  @relation("DriverRoutes")
  safetyChecks            SafetyCheck[]            @relation("DriverSafetyChecks")
  safetyDeclarations      SafetyDeclaration[]      @relation("DriverSafetyDeclarations")
  systemDocumentUploads   SystemDocument[]         @relation("SystemDocumentUploads")
  vehicleAssignments      VehicleAssignment[]      @relation("DriverVehicleAssignments")

  @@index([role])
  @@index([isDeleted])
  @@index([attendanceAppUserId])
  @@map("users")
}

model Customer {
  id                   String     @id @default(uuid())
  name                 String
  address              String
  contactInfo          String?
  preferences          String?
  groupCode            String?
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
  isDeleted            Boolean    @default(false)
  email                String?
  deliveryInstructions String?
  paymentTerms         String?    @default("COD")
  documents            Document[]
  stops                Stop[]

  @@index([name])
  @@index([email])
  @@index([groupCode])
  @@index([isDeleted])
  @@index([paymentTerms])
  @@map("customers")
}

model Route {
  id                      String                   @id @default(uuid())
  routeNumber             String?
  date                    DateTime                 @default(now())
  status                  RouteStatus              @default(PENDING)
  driverId                String?
  uploadedBy              String?
  uploadedAt              DateTime                 @default(now())
  sourceFile              String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  isDeleted               Boolean                  @default(false)
  dailyKPIs               DailyKPI[]               @relation("RouteKPIs")
  documentAcknowledgments DocumentAcknowledgment[]
  driverLocations         DriverLocation[]
  driver                  User?                    @relation("DriverRoutes", fields: [driverId], references: [id])
  safetyChecks            SafetyCheck[]
  safetyDeclarations      SafetyDeclaration[]      @relation("RouteSafetyDeclarations")
  stops                   Stop[]
  vehicleAssignments      VehicleAssignment[]

  @@index([routeNumber])
  @@index([date])
  @@index([status])
  @@index([driverId])
  @@index([isDeleted])
  @@map("routes")
}

model Vehicle {
  id               String              @id @default(uuid())
  vehicleNumber    String              @unique
  make             String?
  model            String?
  year             Int?
  licensePlate     String?
  vin              String?
  fuelType         String              @default("DIESEL")
  status           VehicleStatus       @default(ACTIVE)
  notes            String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  isDeleted        Boolean             @default(false)
  fuelCapKeyNumber String?
  fuelCardNumber   String?
  fuelInstructions String?
  assignments      VehicleAssignment[]

  @@index([vehicleNumber])
  @@index([status])
  @@index([isDeleted])
  @@map("vehicles")
}

model SystemDocument {
  id              String                   @id @default(uuid())
  documentType    SystemDocumentType
  filePath        String
  fileName        String
  isActive        Boolean                  @default(true)
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  isDeleted       Boolean                  @default(false)
  category        DocumentCategory
  description     String?
  fileSize        Int
  isRequired      Boolean                  @default(false)
  mimeType        String
  title           String
  uploadedBy      String
  acknowledgments DocumentAcknowledgment[]
  uploader        User                     @relation("SystemDocumentUploads", fields: [uploadedBy], references: [id])

  @@index([isRequired])
  @@index([isActive])
  @@index([category])
  @@index([uploadedBy])
  @@index([isDeleted])
  @@map("system_documents")
}

model DocumentAcknowledgment {
  id             String         @id @default(uuid())
  documentId     String
  driverId       String
  acknowledgedAt DateTime       @default(now())
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  routeId        String?
  document       SystemDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  driver         User           @relation("DriverDocumentAcknowledgments", fields: [driverId], references: [id], onDelete: Cascade)
  route          Route?         @relation(fields: [routeId], references: [id])

  @@unique([documentId, driverId, routeId])
  @@index([driverId])
  @@index([documentId])
  @@index([routeId])
  @@index([acknowledgedAt])
  @@map("document_acknowledgments")
}

model VehicleAssignment {
  id         String   @id @default(uuid())
  vehicleId  String
  driverId   String
  routeId    String?
  assignedAt DateTime @default(now())
  assignedBy String
  isActive   Boolean  @default(true)
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  isDeleted  Boolean  @default(false)
  driver     User     @relation("DriverVehicleAssignments", fields: [driverId], references: [id])
  route      Route?   @relation(fields: [routeId], references: [id])
  vehicle    Vehicle  @relation(fields: [vehicleId], references: [id])

  @@index([vehicleId])
  @@index([driverId])
  @@index([routeId])
  @@index([isActive])
  @@index([isDeleted])
  @@map("vehicle_assignments")
}

model Stop {
  id                     String           @id @default(uuid())
  routeId                String
  customerId             String
  sequence               Int
  address                String
  customerNameFromUpload String?
  orderNumberWeb         String?
  quickbooksInvoiceNum   String?
  initialDriverNotes     String?
  status                 StopStatus       @default(PENDING)
  arrivalTime            DateTime?
  completionTime         DateTime?
  signedInvoicePdfUrl    String?
  driverNotes            String?
  isCOD                  Boolean          @default(false)
  paymentFlagCash        Boolean          @default(false)
  paymentFlagCheck       Boolean          @default(false)
  paymentFlagCC          Boolean          @default(false)
  paymentFlagNotPaid     Boolean          @default(false)
  returnFlagInitial      Boolean          @default(false)
  driverRemarkInitial    String?
  amount                 Float?
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt
  isDeleted              Boolean          @default(false)
  driverNameFromUpload   String?
  onTheWayTime           DateTime?
  invoiceImageUrls       String[]         @default([])
  driverPaymentAmount    Float?
  driverPaymentMethods   String[]         @default([])
  paymentAmountCC        Float?           @default(0)
  paymentAmountCash      Float?           @default(0)
  paymentAmountCheck     Float?           @default(0)
  totalPaymentAmount     Float?           @default(0)
  paymentTerms           String?
  paymentTermsOther      String?
  creditMemoAmount       Float?
  creditMemoNumber       String?
  adminNotes             AdminNote[]
  creditMemos            CreditMemo[]
  driverLocations        DriverLocation[]
  payments               Payment[]
  returns                Return[]
  stopDocuments          StopDocument[]
  customer               Customer         @relation(fields: [customerId], references: [id])
  route                  Route            @relation(fields: [routeId], references: [id])

  @@index([routeId])
  @@index([customerId])
  @@index([status])
  @@index([driverNameFromUpload])
  @@index([isDeleted])
  @@index([sequence])
  @@map("stops")
}

model Return {
  id                  String   @id @default(uuid())
  stopId              String
  orderItemIdentifier String
  productDescription  String?
  quantity            Int
  reasonCode          String
  warehouseLocation   String?
  vendorCreditNum     String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  isDeleted           Boolean  @default(false)
  productId           String?
  product             Product? @relation(fields: [productId], references: [id])
  stop                Stop     @relation(fields: [stopId], references: [id])

  @@map("returns")
}

model CreditMemo {
  id               String    @id @default(uuid())
  stopId           String
  creditMemoNumber String
  creditMemoAmount Float
  documentId       String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  isDeleted        Boolean   @default(false)
  document         Document? @relation(fields: [documentId], references: [id])
  stop             Stop      @relation(fields: [stopId], references: [id])

  @@index([stopId])
  @@index([documentId])
  @@index([isDeleted])
  @@map("credit_memos")
}

model AdminNote {
  id             String    @id @default(uuid())
  stopId         String
  adminId        String
  note           String
  readByDriver   Boolean   @default(false)
  readByDriverAt DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  isDeleted      Boolean   @default(false)
  admin          User      @relation("AdminNotes", fields: [adminId], references: [id])
  stop           Stop      @relation(fields: [stopId], references: [id])

  @@index([stopId])
  @@index([adminId])
  @@index([readByDriver])
  @@index([isDeleted])
  @@map("admin_notes")
}

model SafetyCheck {
  id                    String        @id @default(uuid())
  routeId               String
  type                  ChecklistType
  responses             Json
  timestamp             DateTime      @default(now())
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  isDeleted             Boolean       @default(false)
  driverId              String
  calledWarehouse       Boolean?
  cashBackAmount        Float?
  creditCardCashAmount  Float?
  creditCardNumber      String?
  date                  DateTime?
  dieselAmount          Float?
  dieselLevel           String?
  dieselReceipt         Boolean?
  dollNumber            String?
  dpfLevel              String?
  electricityBoxPhoto   Boolean?
  frontLightsPhoto      Boolean?
  fuelCapKeyNumber      String?
  mileage1              String?
  mileage2              String?
  notes                 String?
  palletJackNumber      String?
  palletsIn             Int?
  palletsOut            Int?
  palletsPhoto          Boolean?
  strapLevel            String?
  truckJackNumber       String?
  truckNumber           String?
  vehicleConditionVideo Boolean?
  braksWorking          Boolean?
  dolliesSecured        Boolean?
  lightsWorking         Boolean?
  palletJackWorking     Boolean?
  routeReviewed         Boolean?
  strapsAvailable       Boolean?
  tiresCondition        Boolean?
  vehicleClean          Boolean?
  driver                User          @relation("DriverSafetyChecks", fields: [driverId], references: [id])
  route                 Route         @relation(fields: [routeId], references: [id])

  @@index([routeId])
  @@index([driverId])
  @@index([type])
  @@index([isDeleted])
  @@map("safety_checks")
}

model SafetyDeclaration {
  id                  String   @id @default(uuid())
  driverId            String
  routeId             String?
  declarationType     String   @default("DAILY")
  vehicleInspected    Boolean  @default(false)
  safetyEquipment     Boolean  @default(false)
  routeUnderstood     Boolean  @default(false)
  emergencyProcedures Boolean  @default(false)
  companyPolicies     Boolean  @default(false)
  signature           String?
  ipAddress           String?
  userAgent           String?
  acknowledgedAt      DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  isDeleted           Boolean  @default(false)
  driver              User     @relation("DriverSafetyDeclarations", fields: [driverId], references: [id])
  route               Route?   @relation("RouteSafetyDeclarations", fields: [routeId], references: [id])

  @@index([driverId])
  @@index([routeId])
  @@index([declarationType])
  @@index([acknowledgedAt])
  @@index([isDeleted])
  @@map("safety_declarations")
}

model RouteUpload {
  id               String       @id @default(uuid())
  fileName         String
  originalFileName String
  uploadedBy       String
  uploadedAt       DateTime     @default(now())
  processedAt      DateTime?
  status           UploadStatus @default(PENDING)
  errorMessage     String?
  rowsProcessed    Int          @default(0)
  rowsSucceeded    Int          @default(0)
  rowsFailed       Int          @default(0)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  isDeleted        Boolean      @default(false)

  @@index([uploadedBy])
  @@index([status])
  @@index([uploadedAt])
  @@index([isDeleted])
  @@map("route_uploads")
}

model Product {
  id          String   @id @default(uuid())
  name        String
  sku         String   @unique
  description String?
  unit        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isDeleted   Boolean  @default(false)
  Return      Return[]

  @@index([sku])
  @@index([name])
  @@index([isDeleted])
  @@map("products")
}

model CustomerEmail {
  id                 String      @id @default(uuid())
  stopId             String
  customerEmail      String
  subject            String
  body               String
  signedInvoiceUrl   String?
  originalInvoiceUrl String?
  status             EmailStatus @default(PENDING)
  sentAt             DateTime?
  error              String?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  isDeleted          Boolean     @default(false)

  @@index([stopId])
  @@index([status])
  @@index([sentAt])
  @@index([isDeleted])
  @@map("customer_emails")
}

model Document {
  id            String         @id @default(uuid())
  title         String
  description   String?
  type          DocumentType
  fileName      String
  filePath      String
  fileSize      Int
  mimeType      String
  uploadedBy    String
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  isDeleted     Boolean        @default(false)
  customerId    String?
  creditMemos   CreditMemo[]
  customer      Customer?      @relation(fields: [customerId], references: [id])
  uploader      User           @relation("DocumentUploads", fields: [uploadedBy], references: [id])
  stopDocuments StopDocument[]

  @@index([type])
  @@index([uploadedBy])
  @@index([isActive])
  @@index([isDeleted])
  @@index([customerId])
  @@map("documents")
}

model StopDocument {
  id         String    @id @default(uuid())
  stopId     String
  documentId String
  isPrinted  Boolean   @default(false)
  printedAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  isDeleted  Boolean   @default(false)
  document   Document  @relation(fields: [documentId], references: [id])
  stop       Stop      @relation(fields: [stopId], references: [id])

  @@unique([stopId, documentId])
  @@index([stopId])
  @@index([documentId])
  @@index([isPrinted])
  @@index([isDeleted])
  @@map("stop_documents")
}

model FileCategory {
  id            String   @id @default(uuid())
  name          String   @unique
  description   String?
  pathPrefix    String
  maxFileSize   Int      @default(10485760)
  allowedTypes  String[] @default([])
  retentionDays Int      @default(365)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  files         File[]

  @@map("file_categories")
}

model File {
  id           String          @id @default(uuid())
  originalName String
  storedName   String
  filePath     String
  fileSize     Int
  mimeType     String
  categoryId   String?
  uploadedBy   String
  checksum     String
  metadata     Json?
  isArchived   Boolean         @default(false)
  archivedAt   DateTime?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  isDeleted    Boolean         @default(false)
  thumbnails   FileThumbnail[]
  versions     FileVersion[]
  category     FileCategory?   @relation(fields: [categoryId], references: [id])
  uploader     User            @relation("FileUploads", fields: [uploadedBy], references: [id])

  @@index([categoryId])
  @@index([uploadedBy])
  @@index([checksum])
  @@index([isArchived])
  @@index([isDeleted])
  @@index([createdAt])
  @@map("files")
}

model FileVersion {
  id            String   @id @default(uuid())
  fileId        String
  versionNumber Int
  filePath      String
  fileSize      Int
  createdAt     DateTime @default(now())
  file          File     @relation(fields: [fileId], references: [id])

  @@index([fileId])
  @@map("file_versions")
}

model FileThumbnail {
  id        String        @id @default(uuid())
  fileId    String
  size      ThumbnailSize
  filePath  String
  width     Int
  height    Int
  createdAt DateTime      @default(now())
  file      File          @relation(fields: [fileId], references: [id])

  @@index([fileId])
  @@index([size])
  @@map("file_thumbnails")
}

model Payment {
  id        String   @id @default(uuid())
  stopId    String
  amount    Float
  method    String
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  stop      Stop     @relation(fields: [stopId], references: [id], onDelete: Cascade)

  @@index([stopId])
  @@index([method])
  @@map("payments")
}

model DriverLocation {
  id        String   @id @default(uuid())
  driverId  String
  routeId   String?
  stopId    String?
  latitude  Float
  longitude Float
  accuracy  Float?
  timestamp DateTime @default(now())
  createdAt DateTime @default(now())
  driver    User     @relation("DriverLocationUpdates", fields: [driverId], references: [id])
  route     Route?   @relation(fields: [routeId], references: [id])
  stop      Stop?    @relation(fields: [stopId], references: [id])

  @@index([driverId])
  @@index([routeId])
  @@index([stopId])
  @@index([timestamp])
  @@index([createdAt])
  @@map("driver_locations")
}

model DailyKPI {
  id             String    @id @default(uuid())
  driverId       String
  routeId        String?
  date           DateTime
  milesStart     Float?
  milesEnd       Float?
  milesDriven    Float?
  totalDelivered Float     @default(0)
  stopsCompleted Int       @default(0)
  stopsTotal     Int       @default(0)
  timeStart      DateTime?
  timeEnd        DateTime?
  totalTime      Int?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  isDeleted      Boolean   @default(false)
  driver         User      @relation("DriverKPIs", fields: [driverId], references: [id])
  route          Route?    @relation("RouteKPIs", fields: [routeId], references: [id])

  @@unique([driverId, date])
  @@index([driverId])
  @@index([routeId])
  @@index([date])
  @@index([createdAt])
  @@map("daily_kpis")
}

enum DocumentCategory {
  SAFETY
  COMPLIANCE
  PROCEDURE
  POLICY
  TRAINING
  REFERENCE
}

enum SystemDocumentType {
  DAILY_SAFETY_DECLARATION
  SAFETY_INSTRUCTIONS
  COMPANY_POLICY
  FUELING_PROCEDURE
  CUSTOMER_SERVICE_GUIDE
  BREAK_COMPLIANCE
  CALIFORNIA_LAW
  VEHICLE_MAINTENANCE
  EMERGENCY_PROCEDURES
  OTHER
}

enum Role {
  ADMIN
  DRIVER
  SUPER_ADMIN
}

enum RouteStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum StopStatus {
  PENDING
  ON_THE_WAY
  ARRIVED
  COMPLETED
  CANCELLED
  FAILED
}

enum ChecklistType {
  START_OF_DAY
  END_OF_DAY
}

enum UploadStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
}

enum DocumentType {
  INVOICE
  CREDIT_MEMO
  DELIVERY_RECEIPT
  RETURN_FORM
  OTHER
  CUSTOMER_INVOICE
  VENDOR_BILL_WORK_ORDER
  GASOLINE_DIESEL_EXPENSE
  DRIVER_WAREHOUSE_HOURS
  SAFETY_DECLARATION
  STATEMENT
  PURCHASE_ORDER
}

enum ThumbnailSize {
  SMALL
  MEDIUM
  LARGE
}

enum VehicleStatus {
  ACTIVE
  MAINTENANCE
  RETIRED
}
